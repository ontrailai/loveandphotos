import{c as k,u as oe,a as ie,h as ne,r as l,s as i,z as o,j as e,B as g,C as c,e as de,k as ce,V as me,g as w,I as T,f as ue}from"./index-eW4ylyMU.js";import{f as _}from"./index-DhHBP2zF.js";import{I as xe}from"./image-DdibTpAI.js";import{U as he}from"./upload-Ce0LILJP.js";const pe=k("Cloud",[["path",{d:"M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z",key:"p7xjir"}]]),H=k("Copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]),ge=k("File",[["path",{d:"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z",key:"1nnpy2"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}]]),_e=()=>{var R,z;const{user:ye,photographerProfile:m}=oe(),b=ie(),[D]=ne(),S=l.useRef(null),u=D.get("job"),y=D.get("booking"),[r,A]=l.useState(null),[p,C]=l.useState([]),[M,q]=l.useState(!1),[U,F]=l.useState(0),[n,G]=l.useState(0),[J,P]=l.useState(!1),[x,I]=l.useState(""),[f,V]=l.useState(""),[O,Q]=l.useState([]),[W,v]=l.useState(!1);l.useEffect(()=>{u&&y&&K(),Z()},[u,y]);const K=async()=>{try{const{data:s,error:t}=await i.from("job_queue").select(`
          *,
          bookings!inner (
            *,
            customer:users!customer_id (
              full_name,
              email
            ),
            packages (
              title,
              deliverables
            )
          )
        `).eq("id",u).single();if(t)throw t;A(s),P(s.overtime_logged||!1),I(s.delivery_url||""),s.files_uploaded&&s.files_uploaded.length>0&&C(s.files_uploaded)}catch(s){console.error("Error loading job details:",s),o.error("Failed to load job details")}},Z=async()=>{try{const{data:s,error:t}=await i.from("job_queue").select(`
          *,
          bookings!inner (
            event_date,
            customer:users!customer_id (
              full_name
            ),
            packages (
              title
            )
          )
        `).eq("bookings.photographer_id",m==null?void 0:m.id).eq("upload_status","completed").order("delivered_at",{ascending:!1}).limit(5);if(t)throw t;Q(s||[])}catch(s){console.error("Error loading recent deliveries:",s)}},X=async s=>{const t=Array.from(s.target.files);await B(t)},N=s=>{s.preventDefault(),s.stopPropagation(),s.type==="dragenter"||s.type==="dragover"?v(!0):s.type==="dragleave"&&v(!1)},Y=async s=>{if(s.preventDefault(),s.stopPropagation(),v(!1),s.dataTransfer.files&&s.dataTransfer.files[0]){const t=Array.from(s.dataTransfer.files);await B(t)}},B=async s=>{if(!r){o.error("Please select a job first");return}q(!0);const t=[];try{for(let j=0;j<s.length;j++){const h=s[j];F(Math.round((j+1)/s.length*100));const fe=h.name.split(".").pop(),re=`${Date.now()}_${h.name}`,L=`${m.id}/${y}/${re}`,{data:je,error:$}=await i.storage.from("deliverables").upload(L,h,{cacheControl:"3600",upsert:!1});if($)throw $;const{data:{publicUrl:le}}=i.storage.from("deliverables").getPublicUrl(L);t.push({name:h.name,size:h.size,type:h.type,url:le,uploaded_at:new Date().toISOString()})}const a=[...p,...t],{error:d}=await i.from("job_queue").update({files_uploaded:a,upload_status:"in_progress",updated_at:new Date().toISOString()}).eq("id",u);if(d)throw d;C(a),o.success(`${s.length} file(s) uploaded successfully`)}catch(a){console.error("Upload error:",a),o.error("Failed to upload files")}finally{q(!1),F(0)}},ee=async()=>{if(!x){o.error("Please enter a delivery URL");return}try{const s=Math.random().toString(36).slice(-8),{error:t}=await i.from("job_queue").update({delivery_url:x,delivery_password:s,upload_status:"completed",delivered_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",u);if(t)throw t;V(s),await se(),o.success("Delivery completed and customer notified!"),setTimeout(()=>{b("/dashboard/photographer/job-queue")},2e3)}catch(s){console.error("Error generating delivery:",s),o.error("Failed to generate delivery")}},se=async()=>{try{const{error:s}=await i.functions.invoke("send-delivery-email",{body:{to:r.bookings.customer.email,customerName:r.bookings.customer.full_name,deliveryUrl:x,deliveryPassword:f,packageTitle:r.bookings.packages.title,eventDate:r.bookings.event_date}});s&&console.error("Email error:",s)}catch(s){console.error("Failed to send email:",s)}},te=async()=>{var s,t;if(n<=0){o.error("Please enter valid overtime hours");return}try{const{error:a}=await i.from("overtime_requests").insert({job_queue_id:u,photographer_id:m.id,booking_id:y,hours:n,hourly_rate:((s=m.pay_tiers)==null?void 0:s.hourly_rate)||150,total_amount:n*(((t=m.pay_tiers)==null?void 0:t.hourly_rate)||150),status:"pending",created_at:new Date().toISOString()});if(a)throw a;await i.from("job_queue").update({overtime_logged:n,updated_at:new Date().toISOString()}).eq("id",u),P(!0),o.success(`${n} overtime hours logged for billing`)}catch(a){console.error("Error logging overtime:",a),o.error("Failed to log overtime")}},E=s=>{navigator.clipboard.writeText(s),o.success("Copied to clipboard")},ae=s=>{if(s===0)return"0 Bytes";const t=1024,a=["Bytes","KB","MB","GB"],d=Math.floor(Math.log(s)/Math.log(t));return Math.round(s/Math.pow(t,d)*100)/100+" "+a[d]};return e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx("div",{className:"bg-white border-b border-gray-200",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-display font-bold text-dusty-900",children:"Upload Center"}),e.jsx("p",{className:"text-dusty-600 mt-1",children:"Deliver photos and videos to your clients"})]}),e.jsx(g,{variant:"outline",onClick:()=>b("/dashboard/photographer/job-queue"),children:"Back to Job Queue"})]})})}),e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:r?e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsx(c,{className:"bg-gradient-to-br from-blush-50 to-sage-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-dusty-900",children:r.bookings.customer.full_name}),e.jsxs("p",{className:"text-sm text-dusty-600",children:[r.bookings.packages.title," • ",_(new Date(r.bookings.event_date),"MMM dd, yyyy")]})]}),e.jsx(de,{variant:"warning",children:"Upload in Progress"})]})}),e.jsxs(c,{children:[e.jsx("h3",{className:"text-lg font-semibold text-dusty-900 mb-4",children:"Upload Files"}),e.jsxs("div",{className:ce("border-2 border-dashed rounded-lg p-8 text-center transition-colors",W?"border-blush-500 bg-blush-50":"border-gray-300 hover:border-gray-400",M&&"opacity-50 pointer-events-none"),onDragEnter:N,onDragLeave:N,onDragOver:N,onDrop:Y,children:[e.jsx("input",{ref:S,type:"file",multiple:!0,accept:"image/*,video/*",onChange:X,className:"hidden"}),e.jsx(pe,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),M?e.jsxs("div",{children:[e.jsx("p",{className:"text-dusty-600 mb-2",children:"Uploading..."}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-blush-500 h-2 rounded-full transition-all duration-300",style:{width:`${U}%`}})}),e.jsxs("p",{className:"text-sm text-dusty-600 mt-2",children:[U,"% complete"]})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-dusty-900 font-medium mb-2",children:"Drag & drop files here or"}),e.jsx(g,{onClick:()=>{var s;return(s=S.current)==null?void 0:s.click()},children:"Browse Files"}),e.jsx("p",{className:"text-sm text-dusty-600 mt-2",children:"Supported: JPG, PNG, MP4, MOV (Max 500MB per file)"})]})]})]}),p.length>0&&e.jsxs(c,{children:[e.jsxs("h3",{className:"text-lg font-semibold text-dusty-900 mb-4",children:["Uploaded Files (",p.length,")"]}),e.jsx("div",{className:"space-y-2",children:p.map((s,t)=>{var a,d;return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[(a=s.type)!=null&&a.startsWith("image")?e.jsx(xe,{className:"w-5 h-5 text-blue-500"}):(d=s.type)!=null&&d.startsWith("video")?e.jsx(me,{className:"w-5 h-5 text-purple-500"}):e.jsx(ge,{className:"w-5 h-5 text-gray-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-dusty-900",children:s.name}),e.jsxs("p",{className:"text-xs text-dusty-600",children:[ae(s.size)," • Uploaded ",_(new Date(s.uploaded_at),"h:mm a")]})]})]}),e.jsx(w,{className:"w-5 h-5 text-green-500"})]},t)})})]}),e.jsxs(c,{children:[e.jsx("h3",{className:"text-lg font-semibold text-dusty-900 mb-4",children:"Delivery Method"}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(T,{label:"Gallery/Download Link",placeholder:"https://gallery.example.com/client-name",value:x,onChange:s=>I(s.target.value)}),f&&e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsx("p",{className:"text-sm font-medium text-green-900 mb-2",children:"Delivery Details (sent to client)"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-green-700",children:"URL:"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("code",{className:"text-xs bg-white px-2 py-1 rounded",children:x}),e.jsx("button",{onClick:()=>E(x),children:e.jsx(H,{className:"w-4 h-4 text-green-600"})})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-green-700",children:"Password:"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("code",{className:"text-xs bg-white px-2 py-1 rounded",children:f}),e.jsx("button",{onClick:()=>E(f),children:e.jsx(H,{className:"w-4 h-4 text-green-600"})})]})]})]})]}),e.jsx(g,{onClick:ee,className:"w-full",disabled:!x||p.length===0,children:"Complete Delivery & Notify Client"})]})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(c,{className:"border-yellow-200 bg-yellow-50",children:[e.jsx("h3",{className:"text-lg font-semibold text-yellow-900 mb-4",children:"Log Overtime"}),J?e.jsxs("div",{className:"text-center py-4",children:[e.jsx(w,{className:"w-12 h-12 text-yellow-600 mx-auto mb-2"}),e.jsxs("p",{className:"text-yellow-900 font-medium",children:[n," hours logged"]}),e.jsx("p",{className:"text-sm text-yellow-700 mt-1",children:"Billing notification sent"})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-yellow-800",children:"Did you work beyond the scheduled time?"}),e.jsx(T,{type:"number",placeholder:"Hours worked overtime",value:n,onChange:s=>G(parseFloat(s.target.value)),min:"0",step:"0.5"}),e.jsxs(g,{onClick:te,variant:"secondary",className:"w-full",disabled:n<=0,children:[e.jsx(ue,{className:"w-4 h-4 mr-2"}),"Submit Overtime"]})]})]}),((z=(R=r==null?void 0:r.bookings)==null?void 0:R.packages)==null?void 0:z.deliverables)&&e.jsxs(c,{children:[e.jsx("h3",{className:"text-lg font-semibold text-dusty-900 mb-4",children:"Expected Deliverables"}),e.jsx("div",{className:"space-y-2",children:r.bookings.packages.deliverables.map((s,t)=>e.jsxs("div",{className:"flex items-center text-sm text-dusty-600",children:[e.jsx(w,{className:"w-4 h-4 text-green-500 mr-2"}),s]},t))})]}),O.length>0&&e.jsxs(c,{children:[e.jsx("h3",{className:"text-lg font-semibold text-dusty-900 mb-4",children:"Recent Deliveries"}),e.jsx("div",{className:"space-y-3",children:O.map(s=>e.jsxs("div",{className:"text-sm",children:[e.jsx("p",{className:"font-medium text-dusty-900",children:s.bookings.customer.full_name}),e.jsx("p",{className:"text-dusty-600",children:_(new Date(s.delivered_at),"MMM dd, yyyy")})]},s.id))})]})]})]}):e.jsxs(c,{className:"text-center py-12",children:[e.jsx(he,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-dusty-900 mb-2",children:"No Job Selected"}),e.jsx("p",{className:"text-dusty-600 mb-6",children:"Select a job from your queue to start uploading"}),e.jsx(g,{onClick:()=>b("/dashboard/photographer/job-queue"),children:"Go to Job Queue"})]})})]})};export{_e as default};
